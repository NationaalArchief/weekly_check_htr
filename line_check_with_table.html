<!DOCTYPE html>
<html>
<!-- currently broken, save is fixed, but not all the the output gt's are made. I need to  implement a code that takes the files and outputs it as a zip.-->

<head>
    <title>Groundtruth developer Weekly</title>
    <style>
        #fileContainer {
            height: 300px;
            /* Set a fixed height for the container */
            overflow-y: auto;
            /* Add vertical scrollbar if content exceeds the container height */
        }
    </style>
</head>

<body>
    <h1>File Upload and Edit</h1>

    <!-- File upload form -->
    <form>
        <input type="file" id="fileUpload" accept=".png,.txt" multiple>
        <button type="button" onclick="uploadFiles()">Upload</button>
    </form>

    <!-- Display uploaded files -->
    <div id="fileContainer"></div>
    <button type="button" onclick="applyChangesAndPrevious()">Previous</button>
    <button type="button" onclick="applyChangesAndNext()">Next</button>

    <!-- Textbox prompt for editing -->
    <h2>Edit Text File</h2>
    <div id="fileContentContainer">
        <p>Original Content:</p>
        <p id="originalContent"></p>
        <br>
        <p>Changed Content:</p>
        <p id="changedContent"></p>
    </div>
    <textarea id="fileContent" rows="10" cols="50"></textarea>
    <br><br>
    <p id="cer">CER: </p>
    <p id="capitalIndependentCER">Capital Independent CER: </p>
    <p id="simpleCER">Simple CER: </p>
    <button type="button" onclick="applyChanges()">Apply</button>
    <br><br>
    <button type="button" onclick="saveFile()">Save</button>

    <table class="hidden-table">
        <tr>
            <th>Index</th>
            <th>File Pair</th>
            <th>Original Content</th>
            <th>Changed Content</th>
            <th>CER 1</th>
            <th>CER 2</th>
            <th>CER 3</th>
        </tr>
    </table>
    <h1>File Pair Table</h1>
    <table id="filePairTable">
        <tr>
            <th>Index</th>
            <th>File Pair</th>
            <th>Original Content</th>
            <th>Changed Content</th>
            <th>CER 1</th>
            <th>CER 2</th>
            <th>CER 3</th>
        </tr>
    </table>


    <!-- Script -->
    <script>
        var filePairs = []; // Array to store file pairs
        var currentPairIndex = 0; // Index of the current file pair
        var changedContentMap = {}; // Object to store changed content for each file pair

        // Iterate over the filePairs array
        for (let i = 0; i < filePairs.length; i++) {
            const pair = filePairs[i];

            // Check if the pair consists of a TXT and PNG file
            if (pair.file1.endsWith('.txt') && pair.file2.endsWith('.png')) {
                // Add an entry to the changedContentMap for the current pair index
                changedContentMap[i] = {
                    txtContent: pair.file1Content,
                    pngContent: pair.file2Content
                };
            }
        }
        var averageCER = 0; // Average CER
        var averageCapitalIndependentCER = 0; // Average Capital Independent CER
        var averageSimpleCER = 0; // Average Simple CER
        var numChanges = 0; // Number of changes made


        // Function to add a new row to the table
        function addRow(indx, filePair, originalContent, changedContent, cer1, cer2, cer3) {
            var table = document.getElementById("filePairTable");
            var row = table.insertRow(-1);

            var filePairIndex = row.insertCell(0);
            filePairIndex.innerHTML = indx;

            var filePairCell = row.insertCell(1);
            filePairCell.innerHTML = filePair;

            var originalContentCell = row.insertCell(2);
            originalContentCell.innerHTML = originalContent;

            var changedContentCell = row.insertCell(3);
            changedContentCell.innerHTML = changedContent;

            var cer1Cell = row.insertCell(4);
            cer1Cell.innerHTML = cer1;

            var cer2Cell = row.insertCell(5);
            cer2Cell.innerHTML = cer2;

            var cer3Cell = row.insertCell(6);
            cer3Cell.innerHTML = cer3;
        }

        function updateRow(indx, filePair, originalContent, changedContent, cer1, cer2, cer3) {
            var table = document.getElementById("filePairTable");
            var row = table.rows[indx + 1];

            row.cells[0].innerHTML = indx;
            row.cells[1].innerHTML = filePair;
            row.cells[2].innerHTML = originalContent;
            row.cells[3].innerHTML = changedContent;
            row.cells[4].innerHTML = cer1;
            row.cells[5].innerHTML = cer2;
            row.cells[6].innerHTML = cer3;
        }



        function uploadFiles() {
            var fileInput = document.getElementById("fileUpload");
            var fileList = document.getElementById("fileContainer");

            fileList.innerHTML = ""; // Clear previous list
            filePairs = []; // Clear previous file pairs
            currentPairIndex = 0; // Reset the index
            averageCER = 0; // Reset average CER
            averageCapitalIndependentCER = 0; // Reset average Capital Independent CER
            averageSimpleCER = 0; // Reset average Simple CER
            numChanges = 0; // Reset number of changes made

            for (var i = 0; i < fileInput.files.length; i++) {
                var file = fileInput.files[i];
                var fileName = file.name;
                var fileType = file.type;
                var fileExtension = fileName.split(".").pop();
                var fileBaseName = fileName.substring(0, fileName.lastIndexOf("."));

                // Store file pair
                if (fileType === "image/png") {
                    filePairs[fileBaseName] = { png: file };
                }

                if (fileType === "text/plain") {
                    if (filePairs[fileBaseName]) {
                        filePairs[fileBaseName].txt = file;
                    } else {
                        filePairs[fileBaseName] = { txt: file };
                    }

                    // Read the text file content
                    var reader = new FileReader();
                    reader.onload = function (event) {
                        var textContent = event.target.result;
                        addRow(Math.ceil(i / 2), fileBaseName, textContent, textContent, 0.0, 0.0, 0.0);
                    };
                    reader.readAsText(file);
                }
            }



            // Display the first pair
            displayCurrentPair();
        }

        function displayCurrentPair() {
            var fileList = document.getElementById("fileContainer");
            fileList.innerHTML = ""; // Clear previous display

            var currentPair = filePairs[Object.keys(filePairs)[currentPairIndex]];
            if (currentPair) {
                // Display image
                if (currentPair.png) {
                    var img = document.createElement("img");
                    img.src = URL.createObjectURL(currentPair.png);
                    img.width = 500; // Increase image width to 500
                    fileList.appendChild(img);
                }

                // Display text content
                if (currentPair.txt) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        var originalContent = document.getElementById("originalContent");
                        var changedContent = document.getElementById("changedContent");
                        var cerElement = document.getElementById("cer");
                        var capitalIndependentCERElement = document.getElementById("capitalIndependentCER");
                        var simpleCERElement = document.getElementById("simpleCER");

                        // Set the original text content
                        originalContent.innerHTML = e.target.result;

                        // Set the text in the textarea for editing
                        document.getElementById("fileContent").value = e.target.result;

                        // Clear the changed text content and CER values
                        changedContent.innerHTML = "";
                        cerElement.innerHTML = "CER: ";
                        capitalIndependentCERElement.innerHTML = "Capital Independent CER: ";
                        simpleCERElement.innerHTML = "Simple CER: ";
                    };
                    reader.readAsText(currentPair.txt);
                }
            }
        }

        function previousFile() {
            currentPairIndex--;

            // Cycle to the last pair if at the beginning
            if (currentPairIndex < 0) {
                currentPairIndex = Object.keys(filePairs).length - 1;
            }

            displayCurrentPair();
        }

        function nextFile() {
            currentPairIndex++;

            // Cycle back to the first pair if at the end
            if (currentPairIndex >= Object.keys(filePairs).length) {
                currentPairIndex = 0;
            }

            displayCurrentPair();
        }
        // Update average CER values
        function calculateAverageCER(cercolumn) {
            var table = document.getElementById("filePairTable");
            var rows = table.getElementsByTagName("tr");
            var sumCER = 0;
            var count = 0;

            for (var i = 0; i < rows.length; i++) {
                var cells = rows[i].getElementsByTagName("td");
                if (cells.length >= cercolumn) {
                    var cerCell = cells[cercolumn];
                    var cerValue = parseFloat(cerCell.textContent || cerCell.innerText);
                    if (!isNaN(cerValue)) {
                        sumCER += cerValue;
                        count++;
                    }
                }
            }

            var averageCER = count > 0 ? sumCER / count : 0;
            console.log("Average CER: " + averageCER);
            return averageCER;
        }

        function applyChanges() {
            var content = document.getElementById("fileContent").value;
            var originalContent = document.getElementById("originalContent").innerHTML;
            var changedContent = document.getElementById("changedContent");
            var cerElement = document.getElementById("cer");
            var capitalIndependentCERElement = document.getElementById("capitalIndependentCER");
            var simpleCERElement = document.getElementById("simpleCER");

            // Calculate CER values
            var cer = calculateCER(originalContent, content);
            var capitalIndependentCER = calculateCER(originalContent.toLowerCase(), content.toLowerCase());
            var simpleCER = calculateSimpleCER(originalContent.toLowerCase(), content.toLowerCase());

            // Display changed content and CER values
            changedContent.innerHTML = content;
            cerElement.innerHTML = "CER: " + cer + "%";
            capitalIndependentCERElement.innerHTML = "Capital Independent CER: " + capitalIndependentCER + "%";
            simpleCERElement.innerHTML = "Simple CER: " + simpleCER + "%";



            // Call the function to calculate and display the average CER
            var averageCER = calculateAverageCER(4);
            var averageCapitalIndependentCER = calculateAverageCER(5);
            var averageSimpleCER = calculateAverageCER(6);

            numChanges++;
            changedContentMap[currentPairIndex] = content;

            // Ensure that 'i' holds the appropriate value before calling 'updateRow()'
            var i = currentPairIndex; // Assign the desired value to 'i'
            var fileBaseName = Object.keys(filePairs)[currentPairIndex];

            updateRow(i, fileBaseName, originalContent, content, cer, capitalIndependentCER, simpleCER)
        }

        function calculateCER(original, changed) {
            var lenOriginal = original.length;
            var lenChanged = changed.length;
            var cer = levenshteinDistance(original, changed);
            cer = (cer / lenOriginal) * 100;
            return cer.toFixed(2);
        }

        function calculateSimpleCER(original, changed) {
            var lenOriginal = original.length;
            var lenChanged = changed.length;
            var cer = levenshteinDistance(original.replace(/[^a-z0-9]/g, ""), changed.replace(/[^a-z0-9]/g, ""));
            cer = (cer / lenOriginal) * 100;
            return cer.toFixed(2);
        }

        function levenshteinDistance(original, changed) {
            var matrix = [];
            var i, j, cost;

            var lenOriginal = original.length;
            var lenChanged = changed.length;

            if (lenOriginal === 0) {
                return lenChanged;
            }

            if (lenChanged === 0) {
                return lenOriginal;
            }

            for (i = 0; i <= lenOriginal; i++) {
                matrix[i] = [i];
            }

            for (j = 0; j <= lenChanged; j++) {
                matrix[0][j] = j;
            }

            for (i = 1; i <= lenOriginal; i++) {
                for (j = 1; j <= lenChanged; j++) {
                    cost = original.charAt(i - 1) === changed.charAt(j - 1) ? 0 : 1;

                    matrix[i][j] = Math.min(
                        matrix[i - 1][j] + 1, // Deletion
                        matrix[i][j - 1] + 1, // Insertion
                        matrix[i - 1][j - 1] + cost // Substitution
                    );
                }
            }

            return matrix[lenOriginal][lenChanged];
        }

        function printChangedContentMap() {
            var content = "";

            for (var index in changedContentMap) {
                if (changedContentMap.hasOwnProperty(index)) {
                    var originalContent = "";
                    var originalFile = filePairs[Object.keys(filePairs)[index]].txt;

                    // Read the text content of the original file
                    var reader = new FileReader();
                    reader.onload = (function (fileIndex) {
                        return function (e) {
                            originalContent = e.target.result;
                            content += "Original Content:\n" + originalContent + "\n";
                            content += "Changed Content:\n" + changedContentMap[fileIndex] + "\n";
                            content += "------------------------\n";

                            // Check if it's the last entry in the map
                            if (Object.keys(changedContentMap).indexOf(fileIndex) === Object.keys(changedContentMap).length - 1) {
                                // Create a new blob with the content
                                var blob = new Blob([content], { type: "text/plain" });

                                // Create a temporary link element
                                var link = document.createElement("a");
                                link.href = URL.createObjectURL(blob);
                                link.download = "changed_content_map.txt";

                                // Programmatically click the link to trigger the download
                                link.click();
                            }
                        };
                    })(index);
                    reader.readAsText(originalFile);
                }
            }
        }

        function saveFile() {
            var content = changedContentMap[currentPairIndex];
            var currentPair = filePairs[Object.keys(filePairs)[currentPairIndex]];

            if (currentPair && currentPair.txt) {
                // Create a new blob with the updated content
                var blob = new Blob([content], { type: "text/plain" });

                // Create a temporary link element
                var link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = currentPair.txt.name.replace('.txt', 'gt.txt'); // Update file name

                // Programmatically click the link to trigger the download
                link.click();

                // Call the function to calculate and display the average CER
                var averageCER = calculateAverageCER(4);
                var averageCapitalIndependentCER = calculateAverageCER(5);
                var averageSimpleCER = calculateAverageCER(6);


                // Save average CER values to a file
                var averageCERText = "Average CER: " + averageCER.toFixed(2) + "%";
                var averageCapitalIndependentCERText = "Average Capital Independent CER: " + averageCapitalIndependentCER.toFixed(2) + "%";
                var averageSimpleCERText = "Average Simple CER: " + averageSimpleCER.toFixed(2) + "%";
                var averageCERBlob = new Blob([averageCERText + "\n" + averageCapitalIndependentCERText + "\n" + averageSimpleCERText], { type: "text/plain" });
                var averageCERLink = document.createElement("a");
                averageCERLink.href = URL.createObjectURL(averageCERBlob);
                averageCERLink.download = "average_cer.txt";
                averageCERLink.click();
            }
        }

        function saveFileWithContentMap() {
            var content = changedContentMap[currentPairIndex];
            var currentPair = filePairs[Object.keys(filePairs)[currentPairIndex]];

            if (currentPair && currentPair.txt) {
                // Print the changedContentMap
                printChangedContentMap();

                // Create a new blob with the updated content
                var blob = new Blob([content], { type: "text/plain" });

                // Create a temporary link element
                var link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = currentPair.txt.name.replace('.txt', 'gt.txt'); // Update file name

                // Programmatically click the link to trigger the download
                link.click();

                // Call the function to calculate and display the average CER
                var averageCER = calculateAverageCER(4);
                var averageCapitalIndependentCER = calculateAverageCER(5);
                var averageSimpleCER = calculateAverageCER(6);

                // Save average CER values to a file
                var averageCERText = "Average CER: " + averageCER.toFixed(2) + "%";
                var averageCapitalIndependentCERText = "Average Capital Independent CER: " + averageCapitalIndependentCER.toFixed(2) + "%";
                var averageSimpleCERText = "Average Simple CER: " + averageSimpleCER.toFixed(2) + "%";
                var averageCERBlob = new Blob([averageCERText + "\n" + averageCapitalIndependentCERText + "\n" + averageSimpleCERText], { type: "text/plain" });
                var averageCERLink = document.createElement("a");
                averageCERLink.href = URL.createObjectURL(averageCERBlob);
                averageCERLink.download = "average_cer.txt";
                averageCERLink.click();
            }
        }

        function applyChangesAndSave() {
            applyChanges(); // Call the applyChanges() function
            saveFile(); // Call the saveFile() function

        }

        function applyChangesAndSaveWithContentmap() {
            applyChangesW(); // Call the applyChanges() function
            saveFileWithContentMap(); // Call the saveFile() function

        }

        function applyChangesAndNext() {
            applyChanges(); // Call the applyChanges() function
            nextFile();


        }

        function applyChangesAndPrevious() {
            applyChanges(); // Call the applyChanges() function
            previousFile();

        }



    </script>
</body>

</html>